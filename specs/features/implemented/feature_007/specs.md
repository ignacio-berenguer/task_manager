# specs.md — feature_007: Migrate from SQLite to PostgreSQL

## 1. Scope

Replace the SQLite database with PostgreSQL across all modules. Convert all date fields from TEXT to proper `DATE`/`TIMESTAMP` types. Change `tarea_id` from TEXT business key to `SERIAL PRIMARY KEY` (integer auto-increment). Ensure the entire application continues working.

**Modules affected:**
- `db/schema.sql` — Rewrite for PostgreSQL dialect, tarea_id becomes SERIAL PK
- `backend/` — database.py, config.py, models.py, schemas.py, crud.py, routers/tareas.py, routers/acciones.py, agent/* (4 files), pyproject.toml
- `management/` — settings.py, db_init.py, engine.py, manage.py, data_quality.py, pyproject.toml
- `frontend/` — SearchPage.jsx (new tarea form, tarea_id filter type)
- `mcp_server/` — tools/detalle.py, tools/busqueda.py, table_metadata.py (tarea_id type str→int)
- `.env` / `.env.example` files — Backend, Management

---

## 2. PostgreSQL Connection Details

| Parameter | Value |
|-----------|-------|
| Host | `127.0.0.1` |
| Port | `5432` |
| Database | `tasksmanager` |
| User | `task_user` |
| Password | `your_secure_password` |

The database, user, and permissions are already provisioned (see `db/create_user.sql`).

---

## 3. Schema Changes (db/schema.sql)

### 3.1 Remove SQLite-specific constructs

| SQLite | PostgreSQL |
|--------|-----------|
| `PRAGMA foreign_keys = ON` | Remove (PG enforces FKs by default) |
| `PRAGMA journal_mode = WAL` | Remove (PG handles this) |
| `PRAGMA cache_size = -8192` | Remove |
| `INTEGER PRIMARY KEY AUTOINCREMENT` | `SERIAL PRIMARY KEY` (or `INTEGER GENERATED BY DEFAULT AS IDENTITY`) |
| `CREATE TABLE IF NOT EXISTS` | Keep (valid in PG) |
| `INSERT OR IGNORE INTO` | `INSERT INTO ... ON CONFLICT DO NOTHING` |
| `datetime('now')` | `NOW()` |

### 3.2 Date fields — TEXT to proper types

| Table | Column | Current Type | New Type | Rationale |
|-------|--------|-------------|----------|-----------|
| `tareas` | `fecha_siguiente_accion` | TEXT | `DATE` | Pure date, no time component |
| `tareas` | `fecha_creacion` | TEXT | `TIMESTAMP` | Timestamp with precision |
| `tareas` | `fecha_actualizacion` | TEXT | `TIMESTAMP` | Timestamp with precision |
| `acciones_realizadas` | `fecha_accion` | TEXT | `DATE` | Pure date, no time component |
| `acciones_realizadas` | `fecha_creacion` | TEXT | `TIMESTAMP` | Timestamp with precision |
| `acciones_realizadas` | `fecha_actualizacion` | TEXT | `TIMESTAMP` | Timestamp with precision |

**Decision: `DATE` vs `TIMESTAMP`:**
- `fecha_siguiente_accion` and `fecha_accion` are user-facing date fields (YYYY-MM-DD only) → `DATE`
- `fecha_creacion` and `fecha_actualizacion` are system timestamps → `TIMESTAMP` (without timezone, since the app runs in a single timezone context)

### 3.3 Resulting PostgreSQL schema

```sql
-- Parametric tables
CREATE TABLE IF NOT EXISTS estados_tareas (
    id SERIAL PRIMARY KEY,
    valor TEXT NOT NULL UNIQUE,
    orden INTEGER DEFAULT 0,
    color TEXT DEFAULT NULL
);

CREATE TABLE IF NOT EXISTS estados_acciones (
    id SERIAL PRIMARY KEY,
    valor TEXT NOT NULL UNIQUE,
    orden INTEGER DEFAULT 0,
    color TEXT DEFAULT NULL
);

CREATE TABLE IF NOT EXISTS responsables (
    id SERIAL PRIMARY KEY,
    valor TEXT NOT NULL UNIQUE,
    orden INTEGER DEFAULT 0
);

-- Core tables
CREATE TABLE IF NOT EXISTS tareas (
    tarea_id SERIAL PRIMARY KEY,
    tarea TEXT NOT NULL,
    responsable TEXT,
    descripcion TEXT,
    fecha_siguiente_accion DATE,
    tema TEXT,
    estado TEXT,
    notas_anteriores TEXT,
    fecha_creacion TIMESTAMP DEFAULT NOW(),
    fecha_actualizacion TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS acciones_realizadas (
    id SERIAL PRIMARY KEY,
    tarea_id INTEGER NOT NULL REFERENCES tareas(tarea_id) ON DELETE CASCADE,
    accion TEXT NOT NULL,
    fecha_accion DATE,
    estado TEXT,
    fecha_creacion TIMESTAMP DEFAULT NOW(),
    fecha_actualizacion TIMESTAMP DEFAULT NOW()
);

-- Seed data
INSERT INTO estados_tareas (valor, orden) VALUES
    ('Pendiente', 1), ('En Progreso', 2), ('Completada', 3), ('Cancelada', 4)
ON CONFLICT DO NOTHING;

INSERT INTO estados_acciones (valor, orden) VALUES
    ('Pendiente', 1), ('En Progreso', 2), ('Completada', 3)
ON CONFLICT DO NOTHING;
```

---

## 4. Backend Changes

### 4.1 config.py — New DB settings

Replace `DATABASE_PATH` with individual PostgreSQL parameters:

```python
# Database
DB_HOST: str = "127.0.0.1"
DB_PORT: int = 5432
DB_USER: str = "task_user"
DB_PASSWORD: str = "your_secure_password"
DB_NAME: str = "tasksmanager"
DATABASE_ECHO: bool = False
```

### 4.2 database.py — PostgreSQL connection

Replace the SQLite connection string construction with:

```python
DATABASE_URL = f"postgresql://{settings.DB_USER}:{settings.DB_PASSWORD}@{settings.DB_HOST}:{settings.DB_PORT}/{settings.DB_NAME}"
```

Remove `connect_args={"check_same_thread": False}` (SQLite-specific).

### 4.3 models.py — Column type changes

| Column | Old Type | New Type |
|--------|---------|----------|
| `fecha_siguiente_accion` | `Column(Text)` | `Column(Date)` |
| `fecha_accion` | `Column(Text)` | `Column(Date)` |
| `fecha_creacion` | `Column(Text)` | `Column(DateTime)` |
| `fecha_actualizacion` | `Column(Text)` | `Column(DateTime)` |

Import `Date`, `DateTime` from `sqlalchemy`.

### 4.4 schemas.py — Pydantic type changes

| Field | Old Type | New Type |
|-------|---------|----------|
| `fecha_siguiente_accion` | `str \| None` | `date \| None` |
| `fecha_accion` | `str \| None` | `date \| None` |

Import `date` from `datetime`.

**Note:** `fecha_creacion` and `fecha_actualizacion` are not in the Create/Update schemas (they are system-managed), so no schema change is needed for them.

### 4.5 crud.py — Update timestamp handling

The `update()` method currently sets `fecha_actualizacion = datetime.now().isoformat()`. Change to `datetime.now()` (return a `datetime` object, not a string).

### 4.6 API serialization (model_to_dict)

The `model_to_dict()` function returns raw attribute values. With proper `Date`/`DateTime` columns, these will be Python `date`/`datetime` objects. FastAPI's JSON encoder handles these automatically, serializing:
- `date` → `"YYYY-MM-DD"`
- `datetime` → `"YYYY-MM-DDTHH:MM:SS"`

This matches the ISO 8601 format the frontend already expects. **No changes needed** in routers or response models.

### 4.7 pyproject.toml — Add psycopg2-binary

Add `"psycopg2-binary>=2.9.0"` to dependencies.

---

## 5. Management Module Changes

### 5.1 settings.py — New DB configuration

Replace `DATABASE_PATH` with:

```python
DB_HOST = os.getenv('DB_HOST', '127.0.0.1')
DB_PORT = int(os.getenv('DB_PORT', '5432'))
DB_USER = os.getenv('DB_USER', 'task_user')
DB_PASSWORD = os.getenv('DB_PASSWORD', 'your_secure_password')
DB_NAME = os.getenv('DB_NAME', 'tasksmanager')
```

Build a `DATABASE_URL` property for SQLAlchemy/psycopg2:

```python
DATABASE_URL = f"postgresql://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}"
```

### 5.2 db_init.py — PostgreSQL initialization

**Major refactor.** Currently uses raw `sqlite3` connections. Must switch to `psycopg2`:

- Replace `sqlite3.connect(db_path)` with `psycopg2.connect(host=..., port=..., user=..., password=..., dbname=...)`
- Remove file existence checks (`Path(db_path).exists()`) — PostgreSQL databases are not files
- Remove `PRAGMA` checks
- Replace `cursor.executescript(schema_sql)` with `cursor.execute(schema_sql)` (psycopg2 handles multi-statement SQL)
- Replace `SELECT name FROM sqlite_master WHERE type='table'` with `SELECT tablename FROM pg_catalog.pg_tables WHERE schemaname = 'public'`
- The `create_database` function no longer makes sense as "create a .db file". Rename/repurpose it to "initialize schema" (`init_schema`)
- `recreate_tables`: Replace `PRAGMA foreign_keys = OFF` with dropping tables using `CASCADE`. Use `SELECT tablename FROM pg_catalog.pg_tables WHERE schemaname = 'public'` to list tables.

### 5.3 engine.py — PostgreSQL migration engine

**Major refactor.** Currently uses raw `sqlite3` connections:

- Replace `sqlite3.connect(db_path)` with `psycopg2.connect(...)`
- Replace `PRAGMA foreign_keys = ON` → remove (PG enforces by default)
- Replace `?` parameter placeholders with `%s` (psycopg2 syntax)
- Replace `INSERT OR REPLACE INTO` with `INSERT INTO ... ON CONFLICT (tarea_id) DO UPDATE SET ...` (PostgreSQL UPSERT)
- Replace `INSERT OR IGNORE INTO` (for responsables) with `INSERT INTO ... ON CONFLICT DO NOTHING`
- Date values from Excel are already normalized to ISO strings by `normalize_date()`. For DATE columns, psycopg2 accepts both `datetime.date` objects and ISO strings. No change needed in data_quality.py — the returned ISO strings will be automatically cast by PostgreSQL.

### 5.4 manage.py — Update CLI description and arguments

- Change description from "Excel to SQLite" to "Excel to PostgreSQL"
- Remove `--db` argument (no longer a file path). Database connection is entirely via .env.
- Update validation logic (no file existence checks).

### 5.5 data_quality.py — Minor cleanup

- Remove `import sqlite3` if no longer used (the `log_quality_issue` function signature has `conn: sqlite3.Connection` but it only logs via the logging module, so the parameter type hint should be updated).
- The `get_quality_summary` function uses `pd.read_sql_query(query, conn)` which works with any DB-API 2.0 connection (psycopg2 included). The SQL query references a `calidad_datos` table that doesn't exist in the schema — this is legacy code that is effectively dead.

### 5.6 pyproject.toml — Add psycopg2-binary

Add `"psycopg2-binary>=2.9.0"` to dependencies.

---

## 6. .env and .env.example Updates

### 6.1 Backend .env.example

Replace:
```env
DATABASE_PATH=
```

With:
```env
DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=task_user
DB_PASSWORD=your_secure_password
DB_NAME=tasksmanager
```

### 6.2 Management .env.example

Replace:
```env
# DATABASE_PATH=
```

With:
```env
DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=task_user
DB_PASSWORD=your_secure_password
DB_NAME=tasksmanager
```

### 6.3 MCP Server .env.example — No changes

The MCP server communicates only via HTTP to the backend API. It has no database configuration.

### 6.4 Frontend .env.example — No changes

The frontend communicates only via HTTP to the backend API.

---

## 7. Frontend Changes

Date handling requires no changes (ISO 8601 format is preserved by FastAPI's JSON encoder). However, the `tarea_id` type change from TEXT to INTEGER required:

- **SearchPage.jsx**: Removed `tarea_id` input from new tarea form (auto-generated by DB). Changed `tarea_id` search filter from `ilike` (text pattern) to `eq` (exact integer match). Updated form state initialization.
- **DetailPage.jsx, ActionDialogs.jsx**: No changes needed — `tarea_id` is passed as a value via props and URL params; JavaScript handles integer/string transparently in template literals.

---

## 8. MCP Server Changes

The MCP server communicates via HTTP API, not directly with the database. However, the `tarea_id` type change from string to integer required updating tool parameter types:

- **tools/detalle.py**: `obtener_tarea(tarea_id: str)` → `obtener_tarea(tarea_id: int)`
- **tools/busqueda.py**: `buscar_acciones(tarea_id: str)` → `buscar_acciones(tarea_id: int)`
- **table_metadata.py**: Updated field descriptions to reflect integer type

---

## 9. Risk Assessment

| Risk | Mitigation |
|------|------------|
| Data loss during migration | Management CLI does full recreate+migrate from Excel source — data is idempotently reproduced |
| Date parsing failures | `normalize_date()` already returns ISO strings; PostgreSQL accepts ISO strings for DATE columns |
| Search operators breaking on date columns | SQLAlchemy generates correct SQL for both TEXT and DATE comparisons; `gt`, `lt`, `gte`, `lte` work on DATE types |
| `ilike` on date columns | `ilike` is for text pattern matching — using it on DATE columns would error. However, the frontend doesn't use `ilike` on date fields (only on text fields like responsable, tarea, tema). No issue. |
| psycopg2 installation issues on Windows | Use `psycopg2-binary` which includes pre-compiled binaries |
