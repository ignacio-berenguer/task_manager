# Requirements Prompt for feature_032

I have a new feature request. Follow the "Architect First" protocol: create spec.md and plan.md before writing code. Notify me when the documents are ready.

Please create a '/home/nacho/dev/portfolio_migration/specs/features/feature_032/specs.md' and '/home/nacho/dev/portfolio_migration/specs/features/feature_032/plan.md' in order to do that.

## Feature Brief

Now I want to implement a very important capability: (1) with the information stored in transacciones_json, for the records that are pending update in excel, it should be possible to update the information in the excel_source file. It is very important that the mapping from database tables an fields to excel worksheets/tables/column_names is parametrized in an easy to modify way. The update should only succeed if there is exactly 1 row to update with the primary key. The update should only update modified fields, leaving the rest of the fields as they are. Insert operation should check that there is not a previous record in the excel with the primary key. The delete operation should check that there is only a record to delete in the excel with that primary key. All the operations should be managed async by the backend and logged to log file. In the frontend, the user should be notified async when the operation is successful or failure. The result of the operation should be registered in the transacciones_log. For security, the previous values of the excel record should be stored in transacciones_json. (2) A section for transacciones_json should be included in the detail page.

## User Story

As a portfolio manager, I want to propagate database changes (tracked in transacciones_json) back to the original Excel source files, so that the Excel workbooks stay in sync with edits made through the web application — and I want to see the full transaction history for each initiative in its detail page.

## Key Requirements

### Requirement 1: Parameterized DB-to-Excel Mapping

Define a configuration (e.g., JSON/dict) that maps each database table + field to the corresponding Excel workbook, worksheet/table, and column name. This mapping must be easy to modify without code changes.

### Requirement 2: Excel Update (Modify) Operation

- Read the pending transacciones_json records with operation type "update".
- For each record, locate the row in the Excel file using the primary key.
- The update must succeed only if **exactly 1 row** matches the primary key.
- Only modified fields should be updated; unmodified fields must remain untouched.
- Before updating, store the previous Excel cell values in transacciones_json for security/audit.

### Requirement 3: Excel Insert Operation

- For insert operations, verify that **no existing row** in the Excel file has the same primary key before inserting.
- If a duplicate is found, the operation must fail with a clear error.

### Requirement 3a: INSERT Blocked for datos_descriptivos

- INSERT operations on `datos_descriptivos` must **not** be written back to Excel.
- The Excel workbook is the master source for new initiatives (portfolio_id). Creating new portfolio_ids from the web app would cause primary key conflicts with the Excel master.
- When an INSERT transaction targets `datos_descriptivos`, its `estado_excel` should be set to `NO_APLICA` (not `PENDIENTE`).
- New initiatives can only be created from Excel, then migrated into the database.

### Requirement 3b: INSERT on hechos — id_hecho Reconciliation

- INSERT operations on `hechos` are allowed in the Excel write-back.
- However, the `id_hecho` auto-generated by the database (max + 1) may conflict with `id_hecho` values that were added directly in Excel since the last migration.
- When inserting a hecho into Excel, the system must:
  1. Read the current max `id_hecho` from the Excel sheet.
  2. If the Excel max `id_hecho` >= the database `id_hecho` for this record, assign a new `id_hecho` = Excel max + 1.
  3. Update the database record's `id_hecho` to match the value written to Excel, so both stay in sync.
- This ensures no primary key collision between Excel and the database.

### Requirement 4: Excel Delete Operation

- For delete operations, verify that **exactly 1 row** matches the primary key before deleting.
- If zero or more than one row matches, the operation must fail with a clear error.

### Requirement 5: Excel Library — xlwings (not openpyxl)

- The Excel source files may be open simultaneously by other users on SharePoint or on the local machine.
- `openpyxl` requires exclusive file access and will fail with write errors in these scenarios.
- Use **xlwings** instead, which interacts through the Excel application (COM on Windows) and handles file locking, co-authoring, and open files gracefully.
- The backend runs on WSL2 with access to a Windows Excel installation.

### Requirement 6: Async Backend Processing with Logging

- All Excel write operations must be managed asynchronously by the backend.
- All operations must be logged to the configured log file (level INFO by default, configurable via .env).
- Critical operations (start, success, failure) should also be logged to the console.

### Requirement 7: Frontend Async Notification

- The frontend must notify the user asynchronously when an Excel write operation succeeds or fails.
- Notifications should appear without blocking the UI.

### Requirement 8: Transaction Log Registration

- The result of each Excel write operation (success/failure, timestamp, details) must be registered in transacciones_log (or equivalent audit table).

### Requirement 9: Transacciones JSON Section in Detail Page

- Add a new accordion section in the initiative detail page (`/detail/:portfolio_id`) showing all transacciones_json records for that initiative.
- The section should display operation type, timestamp, affected fields, status, and allow the user to view the full JSON diff.

### General Requirements

- The architecture should follow the file specs/architecture/architecture_backend.md and specs/architecture/architecture_frontend.md
- Update the README.md document after all the changes are done.
- Update the relevant architecture docs (specs/architecture/architecture_backend.md, specs/architecture/architecture_frontend.md) after all the changes are done.
- All the configuration needed should be stored in a .env file
- All the operations should be logged to a log file configured in .env file. The default debugging level will be INFO but it can be changed in the .env file
- The most important operations will be also logged to the console

## Constraints

- The existing application functionality from previous versions should be maintained as is, except for the changes in this feature.

## Final instructions

Analyze the current codebase and let me know when the docs are ready for review. Do not start making any modifications to the code until I review the documents and explicitly say so.
